<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>THE Rankings - UFF Comparison Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 6px; }
    .controls { margin-bottom: 12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .chart-card { border: 1px solid #e0e0e0; padding: 8px; border-radius: 6px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .table-sample { margin-top: 18px; border-collapse: collapse; }
    .table-sample th, .table-sample td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    .table-sample th { background: #f7f7f7; }
    #status { color: #666; margin-top:6px; }
    footer { margin-top:18px; font-size:13px; color:#666; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>THE Rankings — UFF Comparison Dashboard</h1>
  <div class="controls">
    <label for="compareSelect"><strong>Compare UFF with:</strong></label>
    <select id="compareSelect"></select>
    <button id="refreshBtn">Refresh</button>
    <span id="status">Loading data...</span>
  </div>
  
  <div style="padding-bottom: 10px"> 
    <label>Start:
      <select id="minYear"></select>
    </label>

    <label>End:
      <select id="maxYear"></select>
    </label>

    <button id="applyFilter">Update</button>
  </div>


  <div id="charts" class="grid"></div>

  <h3>All Brazilian universities (sample)</h3>
  <div id="tableArea"></div>

  <footer>
    Dashboard generated client-side. Data sources:
    <ul>
      <li><a href="https://github.com/pjfernandes/university_ranking/raw/refs/heads/main/the_2017_full.xlsx" target="_blank">the_2017_full.csv</a></li>
      <li><a href="https://github.com/pjfernandes/university_ranking/raw/refs/heads/main/the_2018_full.xlsx" target="_blank">the_2018_full.csv</a></li>
      <li><a href="https://github.com/pjfernandes/university_ranking/raw/refs/heads/main/the_2019_full.xlsx" target="_blank">the_2019_full.csv</a></li>
      <li><a href="https://github.com/pjfernandes/university_ranking/raw/refs/heads/main/the_2020_full.xlsx" target="_blank">the_2020_full.csv</a></li>
      <li><a href="https://github.com/pjfernandes/university_ranking/raw/refs/heads/main/the_2021_full.xlsx" target="_blank">the_2021_full.csv</a></li>
      <li><a href="https://github.com/pjfernandes/university_ranking/raw/refs/heads/main/the_2022_full.xlsx" target="_blank">the_2022_full.csv</a></li>
      <li><a href="https://github.com/pjfernandes/university_ranking/raw/refs/heads/main/the_2023_full.xlsx" target="_blank">the_2023_full.csv</a></li>
      <li><a href="https://github.com/pjfernandes/university_ranking/raw/refs/heads/main/the_2024_full.xlsx" target="_blank">the_2024_full.csv</a></li>
      <li><a href="https://github.com/pjfernandes/university_ranking/raw/refs/heads/main/the_2025_full.xlsx" target="_blank">the_2025_full.csv</a></li>
      <li><a href="https://github.com/pjfernandes/university_ranking/raw/refs/heads/main/the_2026_full.xlsx" target="_blank">the_2026_full.csv</a></li>
    </ul>
  </footer>

<script>
  (async function(){
  const urls = [
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2017_full.csv", year: 2017},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2018_full.csv", year: 2018},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2019_full.csv", year: 2019},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2020_full.csv", year: 2020},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2021_full.csv", year: 2021},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2022_full.csv", year: 2022},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2023_full.csv", year: 2023},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2024_full.csv", year: 2024},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2025_full.csv", year: 2025},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2026_full.csv", year: 2026}
  ];

  const statusEl = document.getElementById('status');
  const compareSelect = document.getElementById('compareSelect');
  const refreshBtn = document.getElementById('refreshBtn');
  const chartsDiv = document.getElementById('charts');
  const tableArea = document.getElementById('tableArea');

  const numericCols = ["Teaching","Research Environment","Research Quality","Industry","International Outlook"];
  const uffName = "Fluminense Federal University";

  const minYearSelect = document.getElementById("minYear");
  const maxYearSelect = document.getElementById("maxYear");

  function parseNumber(v){
    if(v === null || v === undefined) return NaN;
    v = String(v).replace('–','-').trim();
    const m = v.match(/([\d.]+)/);
    return m ? parseFloat(m[1]) : NaN;
  }

  try {
    statusEl.textContent = 'Downloading CSVs...';
    const texts = await Promise.all(urls.map(u => fetch(u.url).then(r=>r.ok?r.text():Promise.reject(r.status))));
    statusEl.textContent = 'Parsing CSVs...';
    let rows = [];
    for(let i=0;i<texts.length;i++){
      const parsed = Papa.parse(texts[i], {header:true, skipEmptyLines:true}).data;
      parsed.forEach(r => { r.Year = urls[i].year; rows.push(r); });
    }

    rows = rows.map(r => {
      const obj = {};
      for(const k in r){ obj[k.trim()] = r[k]; }
      return obj;
    });

    const brazil = rows.filter(r => r.Country && /Brazil/i.test(r.Country));
    brazil.forEach(r => numericCols.forEach(c => r[c] = parseNumber(r[c])));

    const names = [...new Set(brazil.map(r=>r.Name).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    compareSelect.innerHTML = '';
    names.filter(n=>n!==uffName).forEach(n => {
      const o = document.createElement('option'); o.value = n; o.textContent = n; compareSelect.appendChild(o);
    });

    // Popular tabela amostral
    const sampleRows = brazil.slice(0, 10);
    let html = '<table class="table-sample"><thead><tr>';
    ["Name","Country","Year"].concat(numericCols).forEach(h=> html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';
    sampleRows.forEach(r => {
      html += '<tr>';
      ["Name","Country","Year"].concat(numericCols).forEach(k => {
        let v = r[k];
        if(typeof v === 'number' && !isNaN(v)) v = v.toFixed(1);
        html += `<td>${v===undefined||v===null?'':v}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
    tableArea.innerHTML = html;

    statusEl.textContent = 'Ready';

    const start = 2017;
    const end = 2026;

    for (let y = start; y <= end; y++) {
      minYearSelect.add(new Option(y, y));
      maxYearSelect.add(new Option(y, y));
    }

    minYearSelect.value = 2017;
    maxYearSelect.value = 2026;

    function renderFor(compareTo){
      chartsDiv.innerHTML = '';

      const minY = parseInt(minYearSelect.value);
      const maxY = parseInt(maxYearSelect.value);

      const allYears = Array.from({length: maxY - minY + 1}, (_,i)=>minY + i);

      numericCols.forEach(metric => {
        const card = document.createElement('div'); card.className='chart-card';
        const title = document.createElement('div'); title.innerHTML = `<strong>${metric}</strong>`;
        const plotDiv = document.createElement('div'); plotDiv.style.width='100%'; plotDiv.style.height='320px';
        card.appendChild(title); card.appendChild(plotDiv);
        chartsDiv.appendChild(card);

        const dataUff = brazil.filter(r=>r.Name===uffName).map(r=>({...r,Year:+r.Year}));
        const dataCmp = brazil.filter(r=>r.Name===compareTo).map(r=>({...r,Year:+r.Year}));

        const uffY = allYears.map(y=>{
          const d=dataUff.find(e=>e.Year===y);
          return d && !isNaN(d[metric]) ? d[metric] : null;
        });
        const cmpY = allYears.map(y=>{
          const d=dataCmp.find(e=>e.Year===y);
          return d && !isNaN(d[metric]) ? d[metric] : null;
        });

        const trace1 = {
          x: allYears,
          y: uffY,
          mode: 'lines+markers',
          name: uffName,
          line: { dash: 'solid', width: 2 },
          marker: { size: 6 },
          hoverinfo: 'none',
          showlegend: true
        };

        const trace2 = {
          x: allYears,
          y: cmpY,
          mode: 'lines+markers',
          name: compareTo,
          line: { dash: 'dash', width: 2 },
          marker: { size: 6 },
          hoverinfo: 'none',
          showlegend: true
        };

        const annotations = [];
        allYears.forEach((year, i) => {
          if (uffY[i] != null) {
            annotations.push({ x: year, y: uffY[i], text: uffY[i].toFixed(2), showarrow: false, font: { size: 10 }, yanchor: 'bottom' });
          }
          if (cmpY[i] != null) {
            annotations.push({ x: year, y: cmpY[i], text: cmpY[i].toFixed(2), showarrow: false, font: { size: 10 }, yanchor: 'bottom' });
          }
        });

        const layout = {
          margin: { t: 60, r: 60, l: 70, b: 60 },
          xaxis: {
            title: 'Year',
            dtick: 1,
            tickmode: 'linear',
            automargin: true
          },
          yaxis: {
            title: metric,
            automargin: true
          },
          annotations: annotations,
          legend: {
            x: 0,
            y: 1.15,
            orientation: 'h'
          }
        };

        Plotly.newPlot(plotDiv, [trace1, trace2], layout, {
          responsive: true,
          displaylogo: false,
          toImageButtonOptions: {
            format: 'png',
            filename: `university_comparison_${metric}`,
            scale: 2
          }
        });
      });
    }

    let compareToGlobal = compareSelect.options[0]?.value;
    if(compareToGlobal){
      renderFor(compareToGlobal);
      compareSelect.value = compareToGlobal;
    }

    compareSelect.addEventListener('change', e=>{
      compareToGlobal = e.target.value;
      renderFor(compareToGlobal);
    });

    refreshBtn.addEventListener('click', ()=>location.reload());

    document.getElementById("applyFilter").addEventListener("click", () => {
      const minY = parseInt(minYearSelect.value);
      const maxY = parseInt(maxYearSelect.value);
      if(minY > maxY){
        alert("O ano inicial deve ser menor ou igual ao ano final.");
        return;
      }
      renderFor(compareToGlobal);
    });

  } catch(err){
    statusEl.textContent = 'Error: ' + err.message;
    console.error(err);
  }
})();

</script>
</body>
</html>

