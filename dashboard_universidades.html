
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>THE Rankings - UFF Comparison Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 6px; }
    .controls { margin-bottom: 12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .chart-card { border: 1px solid #e0e0e0; padding: 8px; border-radius: 6px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .table-sample { margin-top: 18px; border-collapse: collapse; }
    .table-sample th, .table-sample td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    .table-sample th { background: #f7f7f7; }
    #status { color: #666; margin-top:6px; }
    footer { margin-top:18px; font-size:13px; color:#666; }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>THE Rankings — UFF Comparison Dashboard</h1>
  <div class="controls">
    <label for="compareSelect"><strong>Compare UFF with:</strong></label>
    <select id="compareSelect"></select>
    <button id="refreshBtn">Refresh</button>
    <span id="status">Loading data...</span>
  </div>

  <div id="charts" class="grid"></div>

  <h3>All Brazilian universities (sample)</h3>
  <div id="tableArea"></div>

  <footer>
    Dashboard generated client-side. Data sources:
    <ul>
      <li><a href="https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2024_full.csv" target="_blank">the_2024_full.csv</a></li>
      <li><a href="https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2025_full.csv" target="_blank">the_2025_full.csv</a></li>
      <li><a href="https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2026_full.csv" target="_blank">the_2026_full.csv</a></li>
    </ul>
  </footer>

<script>
(async function(){
  const urls = [
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2024_full.csv", year: 2024},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2025_full.csv", year: 2025},
    {url: "https://raw.githubusercontent.com/pjfernandes/university_ranking/refs/heads/main/the_2026_full.csv", year: 2026}
  ];

  const statusEl = document.getElementById('status');
  const compareSelect = document.getElementById('compareSelect');
  const refreshBtn = document.getElementById('refreshBtn');
  const chartsDiv = document.getElementById('charts');
  const tableArea = document.getElementById('tableArea');

  const numericCols = ["Teaching","Research Environment","Research Quality","Industry","International Outlook"];
  const uffName = "Fluminense Federal University";

  function parseNumber(v){
    if(v === null || v === undefined) return NaN;
    // replace en-dash with hyphen, extract first numeric group
    v = String(v).replace('–','-').trim();
    const m = v.match(/([\d.]+)/);
    return m ? parseFloat(m[1]) : NaN;
  }

  // fetch and parse CSVs
  try {
    statusEl.textContent = 'Downloading CSVs...';
    const texts = await Promise.all(urls.map(u => fetch(u.url).then(r=> { if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.text(); })));
    statusEl.textContent = 'Parsing CSVs...';
    let rows = [];
    for(let i=0;i<texts.length;i++){
      const parsed = Papa.parse(texts[i], {header:true, skipEmptyLines:true}).data;
      const year = urls[i].year;
      parsed.forEach(r => { r.Year = year; rows.push(r); });
    }

    // normalize columns: remove leading/trailing spaces from keys
    rows = rows.map(r => {
      const obj = {};
      for(const k in r){
        obj[k.trim()] = r[k];
      }
      return obj;
    });

    // filter Brazil
    const brazil = rows.filter(r => r.Country && /Brazil/i.test(r.Country));

    // convert numeric columns
    brazil.forEach(r => {
      numericCols.forEach(c => {
        if(r.hasOwnProperty(c)){
          r[c] = parseNumber(r[c]);
        } else {
          r[c] = NaN;
        }
      });
    });

    // build names list
    const namesSet = new Set(brazil.map(r=>r.Name).filter(Boolean));
    const names = Array.from(namesSet).sort((a,b)=> a.localeCompare(b));

    // populate dropdown excluding uff
    compareSelect.innerHTML = '';
    names.filter(n=> n !== uffName).forEach(n => {
      const o = document.createElement('option'); o.value = n; o.textContent = n; compareSelect.appendChild(o);
    });

    // sample table (first 10 unique names)
    const sampleRows = brazil.slice(0, 10);
    let html = '<table class="table-sample"><thead><tr>';
    ["Name","Country","Year"].concat(numericCols).forEach(h=> html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';
    sampleRows.forEach(r => {
      html += '<tr>';
      ["Name","Country","Year"].concat(numericCols).forEach(k => {
        let v = r[k];
        if(typeof v === 'number' && !isNaN(v)) v = v.toFixed(1);
        html += `<td>${v===undefined||v===null?'':v}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
    tableArea.innerHTML = html;

    statusEl.textContent = 'Ready';

    function renderFor(compareTo){
      if(!compareTo) return;
      // clear charts
      chartsDiv.innerHTML = '';
      // for each metric, create a div and plot
      numericCols.forEach(metric => {
        const card = document.createElement('div'); card.className='chart-card';
        const title = document.createElement('div'); title.innerHTML = `<strong>${metric}</strong>`;
        const plotDiv = document.createElement('div'); plotDiv.style.width='100%'; plotDiv.style.height='320px';
        card.appendChild(title); card.appendChild(plotDiv);
        chartsDiv.appendChild(card);

        // data per university
        const dataUff = brazil.filter(r => r.Name === uffName).sort((a,b)=> a.Year - b.Year);
        const dataCmp = brazil.filter(r => r.Name === compareTo).sort((a,b)=> a.Year - b.Year);

        const trace1 = {
          x: dataUff.map(d=>d.Year),
          y: dataUff.map(d=>d[metric]),
          mode: 'lines+markers+text',
          name: uffName,
          line: {dash:'solid', width:2, color:'#1f77b4'},
          text: dataUff.map(d => d[metric].toFixed(2)),
          textposition: 'top center'
        };
        const trace2 = {
          x: dataCmp.map(d=>d.Year),
          y: dataCmp.map(d=>d[metric]),
          mode: 'lines+markers+text',
          name: compareTo,
          line: {dash:'dash', width:2, color:'#d62728'},
          text: dataUff.map(d => d[metric].toFixed(2)),
          textposition: 'top center'
        };

        const layout = {
          margin: {t:30, r:20, l:50, b:40},
          xaxis: {title:'Year', dtick:1, tickmode:'linear'},
          yaxis: {title: metric},
          legend: {orientation:'h', x:0.5, xanchor:'center', y:-0.25}
        };

        Plotly.newPlot(plotDiv, [trace1, trace2], layout, {responsive:true});
      });
    }

    // initial render with first option
    if(compareSelect.options.length>0){
      renderFor(compareSelect.options[0].value);
      compareSelect.value = compareSelect.options[0].value;
    } else {
      statusEl.textContent = 'No Brazilian universities found in the data.';
    }

    compareSelect.addEventListener('change', function(){ renderFor(this.value); });
    refreshBtn.addEventListener('click', function(){ statusEl.textContent='Refreshing...'; location.reload(); });

  } catch(err){
    statusEl.textContent = 'Error: ' + err.message;
    console.error(err);
  }
})();
</script>
</body>
</html>
